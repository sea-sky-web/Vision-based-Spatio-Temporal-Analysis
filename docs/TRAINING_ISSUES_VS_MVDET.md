# 训练困难原因与 MVDet 训练实现的差异

本节总结当前 BEV-PedTrack 训练流程在实践中遇到的困难，并结合 MVDet 的公开训练实现对比分析。重点聚焦于监督信号、检测头设计、数据处理与评估环节存在的缺口。

## 1. 监督信号过于单一
- **仅使用 MSE 约束 Sigmoid 热力图。** `BEVNet.loss` 直接对经过 Sigmoid 的热力图与高斯目标做均方误差，没有对 logit 空间施加约束，也缺乏正负样本权重调节。【F:project/models/model_wrapper.py†L82-L89】【F:project/models/heads/detector.py†L24-L27】
- **与 MVDet 的差异。** MVDet 在训练时对热力图使用带正负权重的 BCE/Focal Loss，并额外预测 offset 与尺寸回归分支；这种多任务监督能缓和正负样本比例失衡并提供更丰富梯度。当前实现只回归一个光滑热力图，极易在稀疏目标场景下出现梯度消失和收敛慢的问题。

## 2. 高斯目标生成过于尖锐
- **固定 σ=1 像素导致有效监督区域极小。** `_build_gt_heatmap_gaussian` 用常量 `sigma_px=1` 生成 3σ 范围窗口，对应 BEV 网格仅覆盖几格像素。【F:project/models/model_wrapper.py†L91-L119】在 0.2~0.4 米级别的栅格上，这会让大部分前景像素梯度接近零。
- **与 MVDet 的差异。** MVDet 会依据目标尺寸或相机高度动态调整高斯半径，确保正样本区域与真实体积匹配。为了稳定训练，需要根据 BEV 分辨率和人体占地调整 σ 或仿照 MVDet 计算自适应半径。

## 3. 检测头缺少位移/尺寸分支
- **推理阶段使用固定尺寸与网格中心。** `decode` 将峰值直接映射到 BEV 栅格中心，并给每个检测填充固定 0.6m×0.6m 框，没有学习到 MVDet 中的亚像素偏移或尺寸回归。【F:project/models/heads/detector.py†L36-L85】
- **与 MVDet 的差异。** MVDet 的检测头会同时输出中心偏移和 box 尺寸，使得解码结果能贴合真值分布并减小量化误差。当前实现缺乏这类回归头，即使热力图收敛也难以在精度指标上达到同等水平。

## 4. 数据预处理与正则化不足
- **仅执行 Resize + ToTensor。** 数据增强管线缺少基本的颜色归一化、亮度/对比度扰动或随机仿射变换，对多视角遮挡场景而言泛化性有限。【F:project/data/transforms.py†L4-L8】
- **与 MVDet 的差异。** MVDet 训练中通常引入颜色抖动、随机裁剪、翻转等增强来提高鲁棒性，也会对像素做 ImageNet 均值方差归一化，避免 backbone 激活分布漂移。缺乏这些正则项会让训练更容易过拟合或出现梯度爆炸/消失。

## 5. 评估反馈与训练目标不一致
- **验证阶段读取的 GT 为空。** `compute_metrics` 只会从 `boxes_world` 里取目标，但数据预处理阶段始终返回空张量，导致指标恒为零，无法真实反映模型收敛情况。【F:project/train.py†L40-L66】【F:project/data/wildtrack_loader.py†L318-L377】
- **与 MVDet 的差异。** MVDet 会直接在 BEV 热力图上计算召回/精度或使用真实坐标评估，从而提供及时的训练反馈。当前实现缺少有效指标，开发者难以判断超参是否合理，加剧了“训练困难”的主观体验。

---

**改进建议：**
1. 参考 MVDet，将热力图损失切换为 focal/BCE 并引入 offset、尺寸等辅助分支。
2. 动态估计高斯半径，使其匹配人体占地或摄像机高度。
3. 在数据增强管线中加入颜色归一化与随机扰动，提升泛化能力。
4. 修正验证指标读取逻辑（使用 `centers_world` 或补齐 `boxes_world`），以便获得可靠的收敛曲线。

以上调整可以显著缩小与 MVDet 训练实现之间的差距，缓解当前训练过程中的稳定性与效率问题。
